const express=require("express"),WebSocket=require("ws"),config=require("./config"),app=express(),port=3001,url="ws://smartapisocket.angelone.in/smart-stream",headers={Authorization:"Bearer "+config.jwtToken,"x-api-key":config.apiKey,"x-client-code":config.clientCode,"x-feed-token":config.feedToken},socket=new WebSocket(url,{headers:headers}),tokenMapping={99919e3:"SENSEX",26e3:"NIFTY 50",99926009:"NIFTY BANK",99926017:"INDIA VIX",99926013:"NIFTY NEXT 50",99926037:"NIFTY FINANCIAL SERVICES",2885:"RELIANCE",3045:"SBIN",3432:"TATACONSUM",11723:"JSWSTEEL",3499:"TATASTEEL",11630:"NTPC",14977:"POWERGRID",10604:"BHARTIARTL",16675:"BAJAFINSV",317:"BAJFINANCE",1348:"HEROMOTOCO",5258:"INDUSINDBK",1333:"HDFCBANK",1922:"KOTAKBANK",11536:"TCS",1594:"INFY",1363:"HINDALCO",17388:"ADANIPOWER",236:"ASIANPAINT",3506:"TITAN",25780:"APLAPOLLO",17963:"NESTLEIND",1660:"ITC",2475:"ONGC",3351:"SUNPHARMA",1232:"GRASIM",10940:"DIVISLAB",881:"DRREDDY",7229:"HCLTECH",3787:"WIPRO",547:"BRITANNIA",694:"CIPLA",910:"EICHERMOT",10999:"MARUTI",14937:"MAHINDCIE",21676:"HINDMOTORS",526:"BPCL",20374:"COALINDIA",13538:"TECHM",1394:"HINDUNILVR",3563:"ADANIGREEN",25:"ADANIENT",5097:"ZOMATO",2664:"PIDILITIND",9819:"HAVELLS",772:"DABUR",3103:"SHREECEM",13611:"IRCTC",9480:"LICI",4204:"MOTHERSON",305:"BAJAJHLDNG",2181:"BOSCHLTD"},tokenIDArray=Object.keys(tokenMapping);socket.on("open",(()=>{socket.send(JSON.stringify({action:1,params:{mode:2,tokenList:[{exchangeType:1,tokens:["99926037"]}]}}))}));const latestData={};socket.on("message",(e=>{const o=new Uint8Array(e);if(4===o.length&&112===o[0]&&111===o[1]&&110===o[2]&&103===o[3])return;const t=o.slice(43,47),n=o.slice(115,122),s=o.slice(2,27),a=t.reduce(((e,o,t)=>e+o*Math.pow(256,t)),0)/100,A=n.reduce(((e,o,t)=>e+o*Math.pow(256,t)),0)/100,c=parseFloat((a-A).toFixed(2)),I=parseFloat((c/a*100).toFixed(2)),r=(new TextDecoder).decode(s).replace(/\u0000/g,""),N={tokenName:tokenMapping[r],ltp:a,yesterdayPrice:A,change:c,percentChange:I};latestData[r]=N,console.log(N)})),socket.on("close",(()=>{console.log("WebSocket connection closed")})),setInterval((()=>{socket.readyState===WebSocket.OPEN&&socket.send("ping")}),29e3),app.use(((e,o,t)=>{o.header("Access-Control-Allow-Origin","*"),o.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),t()})),app.get("/api/prices",((e,o)=>{o.json(latestData)})),app.get("/api/mappings",((e,o)=>{o.json(tokenMapping)})),app.listen(3001,(()=>{console.log("Server listening on port 3001")}));